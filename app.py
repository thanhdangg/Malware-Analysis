import streamlit as st
import requests
import os

API_KEY = "80b983fbe3d76ad3e0a75b20e34508a003961068fde35e641c1e5005cd6f583b"

def upload_and_scan_file(file):
    temp_file_path = os.path.join('temp', file.name)
    
    os.makedirs(os.path.dirname(temp_file_path), exist_ok=True)

    with open(temp_file_path, 'wb') as temp_file:
        temp_file.write(file.getbuffer())

    with open(temp_file_path, 'rb') as file_to_scan:
        files = {'file': file_to_scan}
        response = requests.post('https://www.virustotal.com/vtapi/v2/file/scan', 
                                 files=files, 
                                 params={'apikey': API_KEY})

    file_hash = response.json()['resource']
    st.write(f"File Hash: {file_hash}")

    report_url = 'https://www.virustotal.com/vtapi/v2/file/report'
    params = {
        'apikey': API_KEY,
        'resource': file_hash
    }
    report_response = requests.get(report_url, params=params)
    report_data = report_response.json()

    if report_data['response_code'] == 1:
        st.write("Malware Type Analysis:")
        for engine in report_data['scans']:
            st.write(f"{engine}: {report_data['scans'][engine]['detected']}")
    else:
        st.write("Error fetching report.")

def main():
    st.title("Malware Detection using VirusTotal")
    uploaded_file = st.file_uploader("Choose a file to scan")

    if uploaded_file is not None:
        st.write("Uploaded File:")
        st.write(uploaded_file.name)
        upload_and_scan_file(uploaded_file)

if __name__ == "__main__":
    main()